open Core
open Async
open Hardcaml
open C8.Programmable_cpu_core
open C8.Global
open Helper

let test ~cycles ~rom_file ~create ~print_on_cycle ~print_on_exit =
  let module Simulator = Cyclesim.With_interface (I) (O) in
  let sim = Simulator.create (create ~spec:r_sync) in
  let inputs : _ I.t = Cyclesim.inputs sim in
  let outputs : _ O.t = Cyclesim.outputs sim in
  (* Write the test rom to main memory *)
  sim_program_rom sim inputs ~rom:(String.to_list rom_file |> List.map ~f:Char.to_int);
  (* Simulate the program we just wrote running for 100 cycles *)
  Sequence.range 0 cycles
  |> Sequence.iter ~f:(fun _ ->
         sim_cycle_not_programming sim inputs outputs ~print:print_on_cycle);
  sim_cycle_not_programming sim inputs outputs ~print:print_on_exit;
  printf "Framebuffer\n%s\n" (frame_buffer_as_string sim inputs outputs);
  ()
;;

let%expect_test "Particle" =
  let%bind rom_file = Reader.file_contents "particle.ch8" in
  test ~print_on_exit:true ~print_on_cycle:false ~cycles:30_000 ~rom_file ~create;
  test ~print_on_exit:true ~print_on_cycle:false ~cycles:60_000 ~rom_file ~create;
  [%expect
    {|
      ((core
        ((in_execute 1) (in_fetch 0) (op 1000000000001110)
         (working_op 1000000000101011)
         (registers
          ((pc 001010101110) (i 001100000000) (sp 000000000010)
           (registers
            (00100000 00011110 11111000 00000000 00011111 00000000 00000101
             00000010 00000000 00000000 00000001 00000000 00000000 00000000
             00000000 00000000))))
         (fetch_finished 0) (fetch_cycle 00) (last_op 1000000000001110)
         (executor_done 0) (executor_error 1)
         (memory
          ((read_address 0000000000000000) (write_enable 0)
           (write_address 0000000000000000) (write_data 00000000)))
         (random_state 10111011)))
       (read_data 00101011))
      Framebuffer
      .***.***.***...*.*****...******..***..**.....**..*..****.****.**
      ..**.......**.**.*..**.*...**......**.**.....**..**....*........
      .***.***.****..*.*****.*...**......**.**.....**..*...***..***..*
      ..**.......**....*..**.*...**......**.**.....**........*......**
      ..**.**....**....*..**.*...**....***..**..*****..**.****...**..*
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ((core
        ((in_execute 1) (in_fetch 0) (op 1000000000001110)
         (working_op 1000000000101011)
         (registers
          ((pc 001010101110) (i 001100000000) (sp 000000000010)
           (registers
            (00100000 00011110 11111000 00000000 00011111 00000000 00000101
             00000010 00000000 00000000 00000001 00000000 00000000 00000000
             00000000 00000000))))
         (fetch_finished 0) (fetch_cycle 00) (last_op 1000000000001110)
         (executor_done 0) (executor_error 1)
         (memory
          ((read_address 0000000000000000) (write_enable 0)
           (write_address 0000000000000000) (write_data 00000000)))
         (random_state 00110110)))
       (read_data 00101011))
      Framebuffer
      .***.***.***...*.*****...******..***..**.....**..*..****.****.**
      ..**.......**.**.*..**.*...**......**.**.....**..**....*........
      .***.***.****..*.*****.*...**......**.**.....**..*...***..***..*
      ..**.......**....*..**.*...**......**.**.....**........*......**
      ..**.**....**....*..**.*...**....***..**..*****..**.****...**..*
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................ |}];
  return ()
;;

let%expect_test "Maze" =
  let%bind rom_file = Reader.file_contents "maze.ch8" in
  test ~print_on_exit:true ~print_on_cycle:false ~cycles:30_000 ~rom_file ~create;
  [%expect
    {|
    ((core
      ((in_execute 0) (in_fetch 1) (op 0001001000011100)
       (working_op 0001001000010010)
       (registers
        ((pc 001000011100) (i 001000100010) (sp 000000000000)
         (registers
          (00000000 00100000 00000001 00000000 00000000 00000000 00000000
           00000000 00000000 00000000 00000000 00000000 00000000 00000000
           00000000 00000000))))
       (fetch_finished 0) (fetch_cycle 01) (last_op 0001001000011100)
       (executor_done 0) (executor_error 0)
       (memory
        ((read_address 0000001000011101) (write_enable 0)
         (write_address 0000000000000000) (write_data 00000000)))
       (random_state 10111011)))
     (read_data 00010010))
    Framebuffer
    ......*...............*.......*.......................*.........
    .......*.......*.......*.......*.......*.......*.......*.......*
    ..............*.......................*.......*...............*.
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......................................*.......*...............*.
    .......*.......*.......*.......*.......*.......*.......*.......*
    ......*.......*.......*.......*.......................*.........
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......*...............................*.......................*.
    .......*.......*.......*.......*.......*.......*.......*.......*
    ..............*.......*.......*...............*.......*.........
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......*.......*.......*.......*.................................
    .......*.......*.......*.......*.......*.......*.......*.......*
    ......................................*.......*.......*.......*.
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......*.......*...............................*.......*.......*.
    .......*.......*.......*.......*.......*.......*.......*.......*
    ......................*.......*.......*.........................
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......*.......................*.................................
    .......*.......*.......*.......*.......*.......*.......*.......*
    ..............*.......*...............*.......*.......*.......*.
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ......*...............*.......*...............*.......*.........
    .......*.......*.......*.......*.......*.......*.......*.......*
    ..............*.......................*.......................*.
    .....*.......*.......*.......*.......*.......*.......*.......*..
    ..............*...............*...............................*.
    .......*.......*.......*.......*.......*.......*.......*.......*
    ......*...............*...............*.......*.......*.........
    .....*.......*.......*.......*.......*.......*.......*.......*.. |}];
  return ()
;;

let%expect_test "Blinky" =
  let%bind rom_file = Reader.file_contents "blinky.ch8" in
  test ~print_on_exit:true ~print_on_cycle:false ~cycles:100_000 ~rom_file ~create;
  [%expect
    {|
      ((core
        ((in_execute 1) (in_fetch 0) (op 1000000100001110)
         (working_op 1000000100100010)
         (registers
          ((pc 011111000010) (i 110100110000) (sp 000000000100)
           (registers
            (00000000 00000000 00000000 00000000 00000000 00000000 00000000
             00000000 00000000 00000000 00000000 00000000 00000000 00000000
             00001111 00000000))))
         (fetch_finished 0) (fetch_cycle 00) (last_op 1000000100001110)
         (executor_done 0) (executor_error 1)
         (memory
          ((read_address 0000000000000000) (write_enable 0)
           (write_address 0000000000000000) (write_data 00000000)))
         (random_state 10110100)))
       (read_data 00100010))
      Framebuffer
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................
      ................................................................ |}];
  return ()
;;
